<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <style>

    #tooltip {
      position: absolute;
      width: auto;
      height: auto;
      padding: 2px 2px;
      -webkit-border-radius: 3px;
      -moz-border-radius: 3px;
      border-radius: 3px;
      -webkit-box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      -moz-box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
      pointer-events: none;
      background-color: #bbb;
    }

    #tooltip.hidden {
      display: none;
    }

    #tooltip p {
      margin: 0 0 0 0;
      padding: 2px 2px;
      font-family: sans-serif;
      font-size: 14px;
    }

    div.years_buttons {
      position: fixed;
      top: 5px;
      left: 50px;
    }

    div.years_buttons div {
      background-color: rgb(251, 201, 127);
      padding: 3px;
      margin: 7px;
    }

    </style>
    <style type="text/css">
    .x-axis path {
        stroke:white;
        fill:none;
    }
    .x-axis line {
        fill: none;
        stroke: none;
        stroke-opacity:.8;
        shape-rendering: crispEdges;
    }
    .bars rect {
        fill:steelblue;
        fill-opacity:.9;
    }
    .title {
        font-weight: bold;
    }
    #precise-value {
        fill:black;
        font-size: 12px;
    }
    </style>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  
</head>

<body>

    <div id="tooltip" class="hidden">
      <p id="ditCountryname"></p>
      <p id="ditYear"></p>
      <p id="ditPopulation"></p>
    </div>
    
    <div class="container">
      <div class="main lead text-justify" id="ditTask1Int2">

         <form class="form-inline">
             <fieldset class="form-group row" id="ditTask1Int2Field">
                 <label>Select Year:</label>
             </fieldset>
             <fieldset><h2 id="ditTask1Int2Title"></h2></fieldset>
         </form>

      </div>
    </div>
    

    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript"> 
    
      function drawTask1Int2(europe) {
        //"use strict";
        //if (error) return console.error(error);
        
        // deal with 0 data
        function ditCkeckNum(n) {
            if (n == 0) {
                return "N/A or Unknown"
            }
            return n;
        }
        
        var margin = {top: 50, bottom: 50, left:100, right: 100};
        var width = 1200 - margin.left - margin.right;
        var height = 2000 - margin.top - margin.bottom;

        var years = [];

        for(var i = 1967; i < 2016; i ++) {
            years.push(i);
        }
        
        var options = d3.select("#ditTask1Int2Field")
            .append("select")
            .attr("id", "ditOptions")
            .attr("class", "form-control")
            .selectAll("option")
            .data(years)
            .enter()
            .append("option")
            .text(function(d) {return d;})
            .attr("value", function(d) {return d;})
          
        d3.select('#ditOptions')
            .on("change", function(d) {
                key = this[this.selectedIndex].value;
                gjbrUpdate(key);
                //update(key);
        });
        
        var svg = d3.select("#ditTask1Int2").append("svg")
                    .attr("width", width+margin.left+margin.right)
                    .attr("height", height+margin.top+margin.bottom)
                    .attr("class", "base-svg");
                    
        var tooltip = d3.select("#tooltip").classed("hidden", true),
            ditCountryname = d3.select("#ditCountryname"),
            ditYear = d3.select("#ditYear"),
            ditPopulation = d3.select("#ditPopulation"),
            format = d3.format(" 2.2f");

        svg.on("mousemove", function() {
            // update tooltip position
            tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
            return true;
          });

        gjbrUpdate = function update(year) {
            
            svg.selectAll("*").remove();
                        
            var barSvg = svg.append("g")
                        .attr("transform", "translate("+margin.left+","+margin.top+")")
                        .attr("class", "bar-svg");

            var x = barSvg.append("g")
                    .attr("class", "x-axis");
            
            // filter by year
            var filtered = europe.filter(function(d) {
                return d['Time'] === year;
            });
            
            // order by total population
            filtered = filtered.sort(function(a, b) {
                    return +b['Population, total'] - +a['Population, total'];
            });
            
            //filtered = filtered.slice(0,40);
            
            gjbrfilt = filtered;            
            
            var xMax = d3.max(filtered, function(d) { return +d['Population, total']; } );
            var xMin = 0;

            var xScale = d3.scale.linear().range([0, width]).domain([xMin, xMax]);
            var yScale = d3.scale.ordinal().rangeRoundBands([0, height], 1.8,0);
            yScale.domain(filtered.map(function(d) { return d['Country Code']; }));
            
            gjbrxscale= xScale;      
            
            var numTicks = 5;
            var xAxis = d3.svg.axis().scale(xScale)
                            //.orient("top")
                            .tickSize((-height))
                            .ticks(numTicks)
                            ;
            /*
            d3.select(".base-svg").append("text")
                .attr("x", margin.left)
                .attr("y", (margin.top)/2)
                .attr("text-anchor", "start")
                .text("Total Population " + year)
                .attr("class", "title");
            */
                
            d3.select("#ditTask1Int2Title")
                .text("Total Population " + year);
                
            var groups = barSvg.append("g").attr("class", "labels")
                        .selectAll("text")
                        .data(filtered)
                        .enter()
                        .append("g");
                        
            groups.append("text")
                    .attr("x", "0")
                    .attr("y", function(d) { return yScale(d['Country Code']); })
                    .text(function(d) { return d['Country Code']; })
                    .attr("text-anchor", "end")
                    .attr("dy", ".9em")
                    .attr("dx", "-.32em")
                    .attr("id", function(d,i) { return "label"+i; });
                    
            var bars = groups
                        .attr("class", "bars")
                        .append("rect")
                        .attr("width", function(d) { return xScale(+d['Population, total']); })
                        .attr("height", height/filtered.length)
                        .attr("x", xScale(xMin))
                        .attr("y", function(d) { return yScale(d['Country Code']); })
                        .attr("id", function(d,i) { return "bar"+i; });
                        
            var texts = groups.append("text")
                    .attr("x", function(d) { return xScale(+d['Population, total']); })
                    .attr("y", function(d) { return yScale(d['Country Code']); })
                    .text(function(d) { return ditCkeckNum(d['Population, total']); })
                    .attr("text-anchor", "start")
                    .attr("dy", "1.2em")
                    .attr("dx", "0.32em")
                    .attr("id", "precise-value");
                  
            bars
                .on("mouseover", function(d) {
                    var currentGroup = d3.select(this.parentNode);
                    currentGroup.select("rect").style("fill", "brown");
                    currentGroup.select("text").style("font-weight", "bold");
                    tooltip.classed("hidden", false);
                    ditCountryname.text(d['Country Code']);
                    ditYear.text(d['Time']);
                    ditPopulation.text( ditCkeckNum(d['Population, total']) );
                })
                .on("mouseout", function() {
                    var currentGroup = d3.select(this.parentNode);
                    currentGroup.select("rect").style("fill", "steelblue");
                    currentGroup.select("text").style("font-weight", "normal");
                    tooltip.classed("hidden", true);
                });
            
           
            texts
                .on("mouseover", function(d) {
                    var currentGroup = d3.select(this.parentNode);
                    currentGroup.select("rect").style("fill", "brown");
                    currentGroup.select("text").style("font-weight", "bold");
                    tooltip.classed("hidden", false);
                    ditCountryname.text(d['Country Code']);
                    ditYear.text(d['Time']);
                    ditPopulation.text( ditCkeckNum(d['Population, total']) );
                })
                .on("mouseout", function() {
                    var currentGroup = d3.select(this.parentNode);
                    currentGroup.select("rect").style("fill", "steelblue");
                    currentGroup.select("text").style("font-weight", "normal");
                    tooltip.classed("hidden", true);
                });
                
            x.call(xAxis);
            var grid = xScale.ticks(numTicks);
            barSvg.append("g").attr("class", "grid")
                .selectAll("line")
                .data(grid, function(d) { return d; })
                .enter().append("line")
                    //.attr("y1", margin.bottom)
                    .attr("y1", yScale(filtered[0]['Country Code']) )
                    .attr("y2", height+margin.bottom)
                    .attr("x1", function(d) { return xScale(d); })
                    .attr("x2", function(d) { return xScale(d); })
                    .attr("stroke", "white")
                    //.attr("opacity", 1)
                    ;
        }
        
        /*
        var buttons = d3.select("#ditTask1Int2")
                .append("div")
                .attr("class", "years_buttons")
                .selectAll("div")
                .data(years)
                .enter()
                .append("div")
                .text(function(d) {
                    return d;
                });

        buttons.on("click", function(d) {
            d3.select(".years_buttons")
              .selectAll("div")
              .transition()
              .duration(500)
              .style("color", "black")
              .style("background", "rgb(251, 201, 127)");

            d3.select(this)
              .transition()
              .duration(500)
              .style("background", "lightBlue")
              .style("color", "white");
            gjbrUpdate(d.toString());
            //update(d.toString());
        });
        */
        
        gjbrUpdate("2015");
        //update("2015");
        
    };
    </script>
  <script type="text/javascript">
  /*
    Use D3 to load the tsv file
    */
    d3.tsv("newnewnewtabbed.tsv", drawTask1Int2);
  </script>
 <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!-- Bootstrap - latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

</body>
</html>
