<!DOCTYPE html>
<meta charset="utf-8">
<style>

.country.PRX { fill: #ddc; }
.country.SCT { fill: #ddc; }
.country.WLS { fill: #cdd; }
.country.NIR { fill: #cdc; }
.country.ENG { fill: #dcd; }
.country.IRL { display: none; }

#tooltip {
  position: absolute;
  width: auto;
  height: auto;
  padding: 2px 2px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
  -moz-box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
  pointer-events: none;
  background-color: #bbb;
}

#tooltip.hidden {
  display: none;
}

#tooltip p {
  margin: 0 0 0 0;
  padding: 2px 2px;
  font-family: sans-serif;
  font-size: 14px;
}

</style>
<body>

    <div id="tooltip" class="hidden">
      <p id="countryname"></p>
      <p id="adhesiondate"></p>
    </div>

    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script type="text/javascript"> 
    
      function draw(europe) {
        //"use strict";
        //  if (error) return console.error(error);
        
        
        var tooltip = d3.select("#tooltip").classed("hidden", true),
            countryname = d3.select("#countryname"),
            adhesiondate = d3.select("#adhesiondate"),
            format = d3.format(" 2.2f");
      
        var margin = 75,
            width = 972 - margin,
            height = 615 - margin;

        d3.select("body")
          .append("h2")
          .text("Hello ");

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            ;
            
        svg.append("rect")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("fill", "DeepSkyBlue");
            
        svg.append('g')
           .attr('class', 'map');
            
        svg.on("mousemove", function() {
            // update tooltip position
            tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
            return true;
          });

/*
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);
        */

        /*
        var years = [];

          for(var i = 1930; i < 2015; i += 4) {
            if(i !== 1942 && i !== 1946) {
              years.push(i);
            };
          }~~
          
          
          var countries = topojson.feature(europe, europe.objects.subunits_europe).features;
        */
        var projection = /*d3.geo.mercator()
                               .scale(300) // 140
                               .translate([width / 2, height / 2]) // ranslate([width / 2, height / 2])
                               .center([20, 66])
                               ;*/
                 d3.geo.azimuthalEqualArea().scale(950).translate([262, 1187]).clipAngle(180 - 1e-3).precision(1)
                 ;
                               
                               
        var path = d3.geo.path().projection(projection);
        
        var countries = topojson.feature(europe, europe.objects.subunits_europe).features;
        
        var map = svg.selectAll('path')
                     .data(countries)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .attr("class", function(d) {return "country " /*+ d.properties.SU_A3*/;})
                     .style('fill', 'DarkSalmon')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);
 /*
           
                   svg.selectAll('.label')
                     .data(countries)
                     .enter()
                     .append('text')
                     .attr("class", function(d) {return "label " + d.properties.SU_A3;})
                     .attr("transform", function(d) {return "translate(" + path.centroid(d) + ")";})
                     .attr("dy",".35em")
                     .text(function(d) {return d.properties.SU_A3;});

      svg.selectAll(".country")
         .data(countries)
         .enter().append("path")
         .attr("class", function(d) {return "country " + d.properties.SU_A3;})
         .attr("d", path)
         .on("mouseover", function(d,i) {
            d3.select(this).style({'stroke-opacity':1,'stroke':'#F00'});
            d3.select(this).classed("hidden", false);
            d3.select(this).text(d.properties.SU_A3);
         })
         .on("mouseout", function(d) {
            this.style.stroke = "none";
            d3.select(this).classed("hidden", true);
         });

*/

      function plot_points(data) {
            
            // add stats to each country
            countries.forEach(function(d) {
                data.some(function(n) {
                    if(d.properties.ADM0_A3 == n['Country Code']) return d.stats = n;
                });
            });
            
            // remove countries with no stats
           countries = countries.filter(function(value) {
                return value.hasOwnProperty("stats");
           });
           
           gggg = countries;

            var population_max = d3.max(data, function(d) {
                return d["Population, total"];
            });

            var radius = d3.scale.sqrt()
                           .domain([0, population_max])
                           .range([0, 5]);

            function key_func(d) {
                return d['Time'];
            }

            svg.append('g')
               .attr("class", "bubble")
               .selectAll("circle")
               /*.data(countries.sort(function(a, b) { 
                  gdebug = a;
                  return b.stats['Population, total'] - a.stats['Population, total'];
               }), key_func)*/
               .data(countries)
               .enter()
               .append("circle")
               .attr("transform", function(d) {
                    //var country 
                    return "translate(" + path.centroid(d) + ")";
               })
               //.attr('cx', function(d) { return d['x']; })
               //.attr('cy', function(d) { return d['y']; })
               .attr('r', function(d) {
                    return radius(d.stats['Population, total']);
               })
               .on("mouseover", function(d,i) {
                    d3.select(this).style({'stroke-opacity':1,'stroke':'#F00'});
                    tooltip.classed("hidden", false);
                    countryname.text(d.stats['Population, total']);
                    adhesiondate.text("( "+ d.properties["ADMIN"] +" )");
                    /*d3.select(this).classed("hidden", false);
                    d3.select(this).text(d.stats['Country Code']);*/
               })
               .on("mouseout", function(d) {
                  this.style.stroke = "none";
                  tooltip.classed("hidden", true);
                  //d3.select(this).classed("hidden", true);
               });

      }
      
      
      d3.tsv("newnewnewtabbed.tsv", function(d) {
//        d['attendance'] = +d['attendance'];
  //      d['date'] = format.parse(d['date']);
        return d;
      }, plot_points);
 
    };
    </script>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    d3.json("europe.json", function(error, europe) {
                              if (error) return console.error(error);
                              draw(europe);
    });
  </script>
</body>
</html>
